<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Rover Telemetry</title>
  <style>
    :root {
      --primary: #e5e5e3;
      --secondary: #6b7280;
      --dark: #1f2937;
    }
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #f5f6f8;
      color: var(--dark);
    }
    .container {
      max-width: 1200px;
      margin: 30px auto;
      padding: 20px;
    }
    h2 {
      font-size: 1.5rem;
      margin-bottom: 15px;
    }

    /* Log card */
    .log-entry {
      background: var(--primary);
      border-radius: 10px;
      padding: 15px 20px;
      margin-bottom: 15px;
    }
    .log-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .log-timestamp {
      font-weight: bold;
      color: var(--secondary);
    }
    .log-status {
      font-weight: bold;
      font-size: 0.8rem;
      padding: 3px 8px;
      border-radius: 8px;
      width: fit-content;
    }
    .connected-status {
      background: #d1fae5;
      color: #028a0f;
    }
    .disconnected-status {
      background: #fde2e1;
      color: #dc3545;
    }

    /* Details in 2 rows */
    .log-details {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    .log-row {
      display: flex;
      gap: 30px;
      flex-wrap: wrap;
    }
    .log-item {
      display: flex;
      gap: 5px;
      min-width: 150px;
    }
    .log-row-label {
      font-weight: 500;
      color: var(--secondary);
    }
    .log-row-value {
      font-weight: bold;
      color: var(--dark);
    }

    /* Scroll */
    #logsContainer {
      max-height: 500px;
      overflow-y: auto;
      padding-right: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Telemetry Log</h2>
    <div id="logsContainer"></div>
  </div>

  <script>
    const ROVER_ID = "rover1";

    const steeringMap = {
      0: "Unknown", 1: "Front two wheel", 2: "Rear two wheel", 3: "Zero turn"
    };
    const joystickMap = {
      0: "Neutral", 1: "Forward", 2: "Backward"
    };
    const shearingMap = {
      0: "Home position", 1: "Sensing position", 2: "Cutting position"
    };
    const speedMap = {
      0: "0 kmph", 1: "1 kmph", 2: "2 kmph", 3: "3 kmph", 4: "4 kmph", 5: "5 kmph"
    };

    function checkConnection(hb) {
      return hb >= 1 && hb <= 255;
    }

    async function fetchRoverLogs() {
      try {
        let res = await fetch(`/rover-logs/${ROVER_ID}`);
        let json = await res.json();
        let logs = json.data ?? [];

        let container = document.getElementById("logsContainer");
        container.innerHTML = "";

        logs.forEach(log => {
          let ts = "--";
          if (log.timestamp) {
            if (log.timestamp.seconds)
              ts = new Date(log.timestamp.seconds * 1000).toLocaleTimeString();
            else if (log.timestamp._seconds)
              ts = new Date(log.timestamp._seconds * 1000).toLocaleTimeString();
            else
              ts = new Date(log.timestamp).toLocaleTimeString();
          }

          let entry = document.createElement("div");
          entry.className = "log-entry";

          // Header row
          let header = document.createElement("div");
          header.className = "log-header";

          let tsEl = document.createElement("span");
          tsEl.className = "log-timestamp";
          tsEl.innerText = ts;

          let statusEl = document.createElement("span");
          statusEl.className =
            "log-status " +
            (checkConnection(log.heartbeat)
              ? "connected-status"
              : "disconnected-status");
          statusEl.innerText = checkConnection(log.heartbeat)
            ? "Connected"
            : "Disconnected";

          header.appendChild(tsEl);
          header.appendChild(statusEl);
          entry.appendChild(header);

          // Details in two rows
          let details = document.createElement("div");
          details.className = "log-details";

          let row1 = document.createElement("div");
          row1.className = "log-row";
          let row2 = document.createElement("div");
          row2.className = "log-row";

          let row1Fields = [
            ["Mode:", log.mode ?? 0],
            ["Speed:", speedMap[log.speed] ?? log.speed ?? 0],
            ["Shearing Arm:", shearingMap[log.shearingarm] ?? log.shearingarm ?? 0],
            ["Steering Angle:", (log.angle ?? 0) + "Â°"]
          ];

          let row2Fields = [
            ["Steering Mode:", steeringMap[log.steeringmode] ?? log.steeringmode ?? 0],
            ["Joystick:", joystickMap[log.joystick] ?? log.joystick ?? 0],
            ["Heartbeat:", log.heartbeat ?? 0]
          ];

          row1Fields.forEach(f => {
            let div = document.createElement("div");
            div.className = "log-item";

            let l = document.createElement("span");
            l.className = "log-row-label";
            l.innerText = f[0];

            let v = document.createElement("span");
            v.className = "log-row-value";
            v.innerText = f[1];

            div.appendChild(l);
            div.appendChild(v);
            row1.appendChild(div);
          });

          row2Fields.forEach(f => {
            let div = document.createElement("div");
            div.className = "log-item";

            let l = document.createElement("span");
            l.className = "log-row-label";
            l.innerText = f[0];

            let v = document.createElement("span");
            v.className = "log-row-value";
            v.innerText = f[1];

            div.appendChild(l);
            div.appendChild(v);
            row2.appendChild(div);
          });

          details.appendChild(row1);
          details.appendChild(row2);
          entry.appendChild(details);

          container.appendChild(entry);
        });
      } catch (err) {
        console.error("Error fetching logs:", err);
      }
    }

    setInterval(fetchRoverLogs, 3000);
    fetchRoverLogs();
  </script>
</body>
</html>
