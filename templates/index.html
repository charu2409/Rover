<!-- Add this section below your dashboard cards -->
<div class="container">
  <div class="card" style="grid-column:1/-1;">
    <h1>Telemetry Log</h1>
    <div id="logs" style="max-height: 300px; overflow-y: auto; font-size: 0.9rem;"></div>
  </div>
</div>

<script>
async function fetchRoverData() {
  try {
    let res = await fetch("/rover/rover1");
    let data = await res.json();

    if (data.success) {
      let d = data.data;
      document.getElementById("mode").innerText = d.mode ?? 0;
      
      // Map speed 1-5 to kmph
      let speedMap = {1: "0.5 kmph", 2: "1 kmph", 3: "1.5 kmph", 4: "2 kmph", 5: "2.5 kmph"};
      document.getElementById("speed").innerText = speedMap[d.speed] ?? "0";

      // Shearing arm mapping
      let shearingMap = {0: "Home", 1: "Sensing", 2: "Other", 3: "Mode 3"};
      document.getElementById("shearingarm").innerText = shearingMap[d.shearingarm] ?? 0;

      // Steering Mode mapping
      let steeringMap = {1: "Home Position", 2: "All Wheel", 3: "Zero Turn", 4: "Crab"};
      document.getElementById("steeringmode").innerText = steeringMap[d.steeringmode] ?? 0;

      document.getElementById("angle").innerText = (d.angle ?? 0) + "°";
      document.getElementById("joystick").innerText = d.joystick ?? 0;
      document.getElementById("heartbeat").innerText = d.heartbeat ?? 0;

      let statusEl = document.getElementById("status");
      if (d.heartbeat && d.heartbeat > 0) {
        statusEl.innerText = "Connected";
        statusEl.className = "status connected";
      } else {
        statusEl.innerText = "Disconnected";
        statusEl.className = "status disconnected";
      }

      document.getElementById("lastupdate").innerText =
        new Date().toLocaleTimeString();
    }
  } catch (err) {
    console.error("Error fetching rover data", err);
  }
}

async function fetchRoverLogs() {
  try {
    let res = await fetch("/rover-logs/rover1");
    let data = await res.json();
    if (data.success) {
      let logsContainer = document.getElementById("logs");
      logsContainer.innerHTML = "";
      data.data.forEach(log => {
        let logDiv = document.createElement("div");
        logDiv.style.borderBottom = "1px solid #dcdcdc";
        logDiv.style.padding = "5px 0";

        // Map fields for readability
        let speedMap = {1: "0.5 kmph", 2: "1 kmph", 3: "1.5 kmph", 4: "2 kmph", 5: "2.5 kmph"};
        let steeringMap = {1: "Home Position", 2: "All Wheel", 3: "Zero Turn", 4: "Crab"};
        let shearingMap = {0: "Home", 1: "Sensing", 2: "Other", 3: "Mode 3"};

        let time = log.timestamp?.seconds ? new Date(log.timestamp.seconds*1000).toLocaleTimeString() : "--";

        logDiv.innerHTML = `
          <b>${time}</b><br>
          Mode: ${log.mode ?? 0} &nbsp;&nbsp; Speed: ${speedMap[log.speed] ?? 0}<br>
          Steering Mode: ${steeringMap[log.steeringmode] ?? 0} &nbsp;&nbsp;
          Pot Angle: ${log.angle ?? 0}°<br>
          Joystick: ${log.joystick ?? 0} &nbsp;&nbsp; Shearing: ${shearingMap[log.shearingarm] ?? 0}<br>
          Heartbeat: ${log.heartbeat ?? 0}
        `;
        logsContainer.appendChild(logDiv);
      });
    }
  } catch (err) {
    console.error("Error fetching rover logs", err);
  }
}

// Refresh data every 2s and logs every 3s
setInterval(fetchRoverData, 2000);
setInterval(fetchRoverLogs, 3000);

fetchRoverData();
fetchRoverLogs();
</script>
